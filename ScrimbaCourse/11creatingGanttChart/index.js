var data = [{
        "saida": "03:40",
        "linha": "VE001",
        "codigo": "VE0010254",
        "descricao": "Planalto/SÃ£o Victor/Garagem",
        "carro": "100",
        "km": "35",
        "km_morta": ""
    },
    {
        "saida": "05:30",
        "linha": "L0041",
        "codigo": "L004100GT",
        "descricao": "Viagem de deslocamento",
        "carro": "100",
        "km": "",
        "km_morta": "4,9"
    },
    {
        "saida": "05:45",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "06:10",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "06:25",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "07:10",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "07:25",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "08:10",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "08:25",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "10:30",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "10:45",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "11:15",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "11:30",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "12:00",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "12:15",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "13:00",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "13:15",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "16:00",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "16:15",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "17:00",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "17:15",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "18:00",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "18:15",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "19:00",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "19:15",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "20:00",
        "linha": "L0041",
        "codigo": "L00410001",
        "descricao": "Floresta/Ref.Os 18 do Forte X Alfr.Chaves",
        "carro": "100",
        "km": "3,24",
        "km_morta": ""
    },
    {
        "saida": "20:15",
        "linha": "L0041",
        "codigo": "L00410002",
        "descricao": "Ref.Os 18 do Forte X Alfr.Chaves/Shopping Iguatemi/Floresta",
        "carro": "100",
        "km": "6,55",
        "km_morta": ""
    },
    {
        "saida": "20:30",
        "linha": "L0041",
        "codigo": "L004100TG",
        "descricao": "Viagem de deslocamento",
        "carro": "100",
        "km": "",
        "km_morta": "3,5"
    },
    {
        "saida": "23:00",
        "linha": "ESP19",
        "codigo": "ESP190011",
        "descricao": "Sai Hosp.Geral/Bairros",
        "carro": "100",
        "km": "41",
        "km_morta": ""
    }
]

data = dataFilter(data)

var svgWidth = 1350,
    svgHeight = 900;

var margin = { top: 45, right: 40, bottom: 80, left: 55 };
var width = svgWidth - margin.left - margin.right;
var height = svgHeight - margin.top - margin.bottom;
var svg = d3.select('svg')
    .attr("width", svgWidth)
    .attr("height", svgHeight)
    .attr("class", "svg-container");

var cars = d3.groups(data, d => d.carro);
var linhas = d3.groups(cars[0][1], d => d.linha);
var mediaName = linhas.map(d => d[0])

var color = d3.scaleOrdinal().domain(mediaName).range(['#E41A10', '#FFD000', '#059451', '#984EA3', '#FF7F00', '#999999', '#A69620', '#377FFF', '#F781BF', '#9FDFD9']);

window.addEventListener('DOMContentLoaded', (event) => {
    dataFilterPoints(data)
    drawChart();
});

function drawChart() {
    var domains = [0, 1440]

    const g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        .attr("class", `chart1`)

    const gChart = g.append("g")
        .attr("transform", "translate(" + 0 + "," + 10 + ")")

    var x1 = d3.scaleLinear()
        .domain(domains)
        .rangeRound([0, width]);

    var x2 = d3.scaleLinear()
        .domain(domains)
        .rangeRound([0, width]);

    var y = d3.scaleBand()
        .domain(mediaName.map(function(x) { return x }))
        .range([0, height])
        .paddingInner(0.6)
        .paddingOuter(1)

    var x1Generator = d3.axisBottom(x1).tickSize(10).tickValues(d3.range(0, 1440, 60));
    var x2Generator = d3.axisTop(x2).tickSize(10).tickValues(d3.range(0, 1440, 60));
    var yGenerator = d3.axisLeft(y)

    let xTickLabels = e => `${Math.floor(e / 60)}:${(e % 60).toString().padStart(2, '0')}`;
    x1Generator.tickFormat((d) => xTickLabels(d));
    x2Generator.tickFormat((d) => xTickLabels(d));

    yGenerator.ticks(mediaName.length);
    let yTickLabels = e => e;
    yGenerator.tickFormat((d) => yTickLabels(d));

    gChart.append("g")
        .attr("transform", "translate(0," + height + ")")
        .attr("class", "xAxis1")
        .attr('stroke-width', 3)
        .call(x1Generator)

    gChart.append("g")
        .attr("transform", "translate(0,0)")
        .attr("class", "xAxis2")
        .attr('stroke-width', 3)
        .call(x2Generator)

    gChart.append("g")
        .attr("transform", "translate(0,0)")
        .attr("class", "yAxis1")
        .attr('stroke-width', 3)
        .call(yGenerator)

    gChart.selectAll(".xAxis1 text")
        .attr("color", "#262D36")
        .attr("font-size", 14)
        .attr("font-weight", 400);

    gChart.selectAll(".xAxis2 text")
        .attr("color", "#262D36")
        .attr("font-size", 14)
        .attr("font-weight", 400)

    drawYTicks(gChart);
    drawTicks(gChart, x1);
    drawLines(gChart, x1, y);
    drawLabels(gChart)
    drawRects(gChart, x1, y)
}

function drawRects(group, x, y) {
    group.selectAll('rect')
        .data(data)
        .enter()
        .append('rect')
        .attr('y', 0)
        .attr('height', y.bandwidth())
        .attr('width', d => x(d.entrada) - x(d.saida))
        .attr('opacity', "1")
        .attr("rx", 6)
        .attr("ry", 6)
        .style("fill", d => color(d.linha))
        .attr('transform', d => rectTransform(d, x, y));
}

function drawTicks(group, x) {
    var {
        tickHours,
        tick10Min,
    } = populateTicks()

    const gridHours = group.selectAll("lines")
        .data(tickHours)
        .join("g")

    gridHours.append("line")
        .attr("x1", (d) => x(d))
        .attr("x2", d => x(d))
        .attr("y1", height)
        .attr("y2", 0)
        .attr("stroke-opacity", 0.9)
        .attr("stroke", "currentColor")
        .attr("stroke-width", 1);

    const grid10Min = group.selectAll("lines")
        .data(tick10Min)
        .join("g")

    grid10Min.append("line")
        .attr("x1", (d) => x(d))
        .attr("x2", d => x(d))
        .attr("y1", height)
        .attr("y2", 0)
        .attr("stroke-opacity", 0.35)
        .attr("stroke", "currentColor")
        .attr("stroke-width", 1)
        .style("stroke-dasharray", ("3, 3"));
}

function drawLines(group, x, y) {
    const lines = group.selectAll("lines")
        .data(linhas)
        .enter()
        .append("g")

    lines.append("line")
        .attr("x1", x(-8))
        .attr("x2", x(1440))
        .attr("y1", d => (y.bandwidth() / 2) + y(d[0]))
        .attr("y2", d => (y.bandwidth() / 2) + y(d[0]))
        .attr("stroke", d => color(d[0]))
        .attr("stroke-width", 1)
}

function drawYTicks(group) {
    var ticks = group.selectAll(".yAxis1 .tick");

    ticks.attr("class", (d) => `tick${d}`)
        .attr("stroke-width", "0");

    mediaName.forEach(car => {
        var carTick = group.select(`.yAxis1 .tick${car}`)
        carTick.attr("color", color(car))
            .attr("font-size", 16)
            .attr("font-weight", 500)
    })
}

function rectTransform(data, x, y) {
    return "translate(" + x(data.saida) + "," + y(data.linha) + ")";
};

function populateTicks() {
    var tickHours = [],
        tick10Min = [];

    var tickHoursCount = 60;
    tickHours.push([])
    for (let j = 0; j < 24; j++) {
        tickHours.push(tickHoursCount);
        tickHoursCount += 60;
    }

    var tick10MinCount = 10;
    for (let j = 0; j < 144; j++) {
        tick10Min.push(tick10MinCount);
        tick10MinCount += 10;
    }

    return { tickHours, tick10Min }
}

function drawLabels(group) {
    const carLabel = group.append("g")
        .attr("transform", "translate(20,55), rotate(-90)")
        .attr("class", "gCarLabel")

    carLabel.append("text")
        .attr("class", "carLabel")
        .text("LINHAS");

    var carLabelAttr = group.select(`.gCarLabel .carLabel`)
    carLabelAttr.attr("color", "#3874A8")
        .attr("font-size", 12)
        .attr("font-weight", 700)

    const timeLineLabel = group.append("g")
        .attr("transform", "translate(10," + (height - 10) + ")")
        .attr("class", "gTimeLineLabel");

    timeLineLabel.append("text")
        .attr("color", "#3874A8")
        .attr("font-size", 12)
        .attr("font-weight", 700)
        .attr("class", "timelineLabel")
        .text("LINHA DO TEMPO");
}

function dataFilter(data) {
    data = data.filter(element => element.descricao !== 'Viagem de deslocamento' || element.descricao === 'Viagem de Deslocamento entre Terminais')

    data = data.map((element) => {
        if (element.km === "\r" || element.km === "") {
            element.km = 0
        }
        return {
            ...element,
            saida: parseFloat(element.saida.toString()) * 60 + parseInt(element.saida.toString().slice(-2)),
            entrada: (parseFloat(element.saida.toString()) * 60 + parseInt(element.saida.toString().slice(-2))) + parseInt(element.km) / 18 * 60
        }
    })

    return data
}

function dataFilterPoints(data) {
    var cars = d3.groups(data, d => d.carro);
    cars = cars.map(car => {
        return car[1].map((points, index) => {
            let entrada = car[1][index].entrada
            let saida = 0
            let next = false
            let previous = false
            let nextPoint = {}
            let previousPoint = {}

            if (car[1][index + 1]) {
                next = true
                nextPoint = car[1][index + 1]
                saida = car[1][index + 1].saida
            }
            if (car[1][index - 1]) {
                previous = true
                previousPoint = car[1][index - 1]
            }
            if ((next && previous) && (saida - entrada) > 45) {
                car[1][index + 1].ocioso = true
                points.ocioso = true
            }

            return {...points }
        })
    })
    return cars
}